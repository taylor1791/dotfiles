#!/usr/bin/env bash
set -e

CONFIG_DIR="${HOME}/.config/daily"
DAILY_FILE="${CONFIG_DIR}/daily"
TRICKLE_FILE="${CONFIG_DIR}/trickle"

function init() {
  if ! [[ -d "${CONFIG_DIR}" ]]; then
    mkdir -p "${CONFIG_DIR}"
  fi

  if ! [[ -f "${DAILY_FILE}" ]]; then
    touch "${DAILY_FILE}"
  fi

  if ! [[ -f "${TRICKLE_FILE}" ]]; then
    touch "${TRICKLE_FILE}"
  fi
}

function open_daily() {
  # A new instance of firefox, _on the current desktop_.
  firefox 2> /dev/null &

  declare url
  cat "${DAILY_FILE}" | while read -r url; do
    _open "${url}"
  done
}

function open_trickle() {
  declare trickle="$(head -n 1 ${TRICKLE_FILE})"
  if [[ "${trickle}" != "" ]]; then
    _open "${trickle}"
    push "${trickle}"
    unshift
  fi
}

# Append trickle entry
function push() {
  echo "${1}" >> "${TRICKLE_FILE}"
}

# Display and remove last trickle entry
function pop() {
  tail -n -1 ${TRICKLE_FILE}
  echo "$(head -n -1 ${TRICKLE_FILE})" > ${TRICKLE_FILE}
}

# Remove first trickle entry
function unshift() {
  echo "$(tail -n +2 ${TRICKLE_FILE})" > ${TRICKLE_FILE}
}

function help() {
  echo "USAGE: daily [push|pop <url>|help]"
  echo ""
  echo "    push   Add an item to the trickle list."
  echo "    pop    Remove the last trickle item."
  echo "    help   Display this message."
  exit 1
}

function _open() {
  if command -v open > /dev/null; then
    open "${@}"
  elif command -v xdg-open > /dev/null; then
    xdg-open "${@}"
  fi
}

if [[ "${1-}" == "push" ]]; then
  if [[ "${2-}" == "" ]]; then
    help
  fi

  push "${2}"
elif [[ "${1-}" == "pop" ]]; then
  pop
elif [[ "${1-}" == "help" ]]; then
  help
else
  init
  open_daily
  open_trickle
fi
